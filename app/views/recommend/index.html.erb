<div class="row">
    <div class="step123">
        <div class="step123_each">
            <span class="no_line_break">
                <span style="color: rgba(1,1,1,0.4)">&nbsp;STEP 1: Add Products&nbsp;</span>
            </span>
        </div>
        <div class="step123_each">
            <span class="no_line_break">
                <span style="color: rgba(1,1,1,0.4)">&nbsp;STEP 2: Analyze&nbsp;</span>
            </span>
        </div>
        <div class="step123_each">
            <span class="no_line_break">&nbsp;[ &nbsp; STEP 3: Results &nbsp; ]&nbsp;</span> 
        </div>
    </div>

    <% @total = [] %>
    
    <div class="tips">
            >>> Ingredients potentially causing breakout are highlighted. If you know certain ingredients are actually safe for you, go back to the previous page and de-select those ingredients to update results.
    </div>
    
    <div class="results">   
        <!-- @count_hash to collect potential ingredients to display graphs --> 
        
            <% if params[:product] %>
                <div class="brand_product">
                    <h4>Product Analysis</h4>
                    Product: <%= Product.where(id: params[:product]).pluck(:product).first %></br>
                    Ingredient analysis:
                </div>
            <% elsif params[:manual_product] and params[:manual_ingredients] %>
                <div class="brand_product">
                    <h4>Manually Entered Product Analysis</h4>
                    Product: <%= params[:manual_product] %></br>
                    Ingredient analysis:
                </div>
            <% else %>
                <div class="brand_product">
                    <h4>Nothing found. Please go back to the previous page.</h4>        
                </div>
            <% end %>
        
                <div class="chart_container">
                    <canvas id="barChart"></canvas>
                </div>

     <!--   <div class="chart_container">
            <p>Overall Hazard</p>
            <canvas id="overall_hazard" width="500" height="500"></canvas>
        </div>-->
    <!-- collect all potential ingredients of recommended products for graphic display -->

        
    <% if @ingredient_hash.present? %>
       <!-- for data_target attribute for ingredient collapse id per loop, i.e. id = 1_5 for first result_list & fifth ingredient for that group -->
       <% result_list_counter=0 %>
       
       <!-- key = product id -->
       <% @ingredient_hash.each do |key, value| %>
       <div class="result_list">
       <!-- p for each product -->
       <p>
            <div class="product"><%= Product.where(id: key).pluck(:product).first %></div></br>
            <div class="product_img"><%= image_tag("product_images/#{Product.where(id: key).pluck(:img).first}", alt: "no image available") %></div></br>
            <div class="product_claims"><%= Product.where(id: key).pluck(:claims).first %></div>
           <!--  <div class="amazon_buy">Buy Now</div> -->
            <% unless current_user.favorites.exists?(key) %>
                <%= link_to favorite_product_path(Product.where(id: key).map(&:id).first), method: :put, remote: true do %><div class="add_faves" id="add_faves_<%= result_list_counter %>">&star;</div><% end %>
                <%= link_to favorite_product_path(Product.where(id: key).map(&:id).first), method: :delete, remote: true do %><div class="remove_faves" id="remove_faves_<%= result_list_counter %>" style="display: none;">&starf;</div><% end %>
            <% else %>
                <%= link_to favorite_product_path(Product.where(id: key).map(&:id).first), method: :put, remote: true do %><div class="add_faves" id="add_faves_<%= result_list_counter %>" style="display: none;">&star;</div><% end %>
                <%= link_to favorite_product_path(Product.where(id: key).map(&:id).first), method: :delete, remote: true do %><div class="remove_faves" id="remove_faves_<%= result_list_counter %>">&starf;</div><% end %>
            <% end %>

            <%= link_to new_suggest_path do %><div class="report_error">Error?</div><% end %>
            <br style="clear:left;"/><br />
                <!-- javascript added here to loop through result_list_counter for product-favorite matching -->
                <script>
                $(document).ready(function(){
                    $('#add_faves_<%= result_list_counter %>').on('click', function(){
                        document.getElementById('remove_faves_<%= result_list_counter %>').style.display = 'block';
                        document.getElementById('add_faves_<%= result_list_counter %>').style.display = 'none';
                    });
                    $('#remove_faves_<%= result_list_counter %>').on('click', function(){
                        document.getElementById('add_faves_<%= result_list_counter %>').style.display = 'block';
                        document.getElementById('remove_faves_<%= result_list_counter %>').style.display = 'none';
                    });
                });
                </script>
            <div class="ingredient_count"><span style="color:rgba(255,0,0,1); font-size: 15px;"><%= value.count %></span> ingredient(s) found:
            </div>
            <div class="legend">
                <span style="background: rgba(255,255,0,1);">&nbsp;&nbsp;&nbsp;</span>:Breakout-causing List | <%= image_tag("canada_flag.png", alt: " [Health Canada] ", size: "19") %>:HC Hotlist | <%= image_tag("eu_flag.png", alt: " [EU] ", size: "19") %>:EU Prohibited List | <%= image_tag("comedogenic_icon.png", alt: " [Comedogenic List] ", size: "19") %>:Comedogenic List | <%= link_to how_it_works_path do %>How It Works&quest;<% end %>
            </div> 
            <!-- use i as a counter for data-target & collapse id matching -->
            <% i=0 %>
            <div class="ingredients_list">
                <!-- downcase and strip b/c @potential_product is already downcased and stripped -->
                <% value.compact.map(&:downcase).map(&:strip).each do |inci| %>
                    <% unless inci.nil? %>
                    <div class="collapse_view" data-toggle="collapse" data-target="#<%= result_list_counter %>_<%= i %>" aria-expanded="false" aria-controls="collapseExample">
                        <!-- css .highlight if potential ingredient -->
                        <% if @potential_product.nil? %>
                        <%= inci %>
                        <% elsif @potential_product.include?(inci) %>
                            <span style="background: rgba(255,255,0,1);"><%= inci %></span>
                        <% else %>
                        <%= inci %>
                        <% end %>

                    <%= image_tag("canada_flag.png", alt: " [Health Canada] ", size: "19") if Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).exists? %>
                    <%= image_tag("eu_flag.png", alt: " [EU] ", size: "19") if CosingAnnexIi.where(chemical_name_inn: inci).exists? %>
                    <%= image_tag("comedogenic_icon.png", alt: " [Comedogenic List] ", size: "19") if Comedogeniclist.where(ingredient: inci).exists? %>
                    </div>
                  
                    <div class="collapse" id="<%= result_list_counter %>_<%= i %>">
                      <div class="well">
                        <p>
                        <div class="title">Function:</div>
                        <% if Cosing.where(INCI_name: inci).pluck(:Function).nil? or Cosing.where(INCI_name: inci).pluck(:Function).empty? %>
                            Unknown
                        <% else %>
                            <%= Cosing.where(INCI_name: inci).pluck(:Function).first %>
                        <% end %>
                        </p>
                        <p>
                            <% if Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).exists? %>
                            <div class="toggle_HC">>>> Health Canada's Hotlists <<<</br>
                                <div class="title">Status (restricted/prohibited):</div> <%= Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).pluck(:status).first || "N/A" %>
                                </br>
                                <div class="title">Conditions of Use:</div> <%= Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).pluck(:conditions_of_use).first || "N/A" %>
                                </br>
                                <div class="title">Maximum concentration permitted:</div> <%= Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).pluck(:maximum_concentration_permitted).first || "N/A" %>
                                </br>
                                <div class="title">Warnings & Cautions:</div> <%= Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).pluck(:warnings_and_cautions).first || "N/A" %>
                                </br>
                            </div>
                        <% end %>
                        </p>
                        <p>
                            <% if CosingAnnexIi.where(chemical_name_inn: inci).exists? %>
                            <div class="toggle_EU">>>> European Union's Prohibited List <<<</br>
                                <div class="title">Opinions:</div> <%= CosingAnnexIi.where(chemical_name_inn: inci).pluck(:sccs_opinions).first || "N/A"%>
                                </br>
                                <div class="title">Other directives/regulations:</div> <%= CosingAnnexIi.where(chemical_name_inn: inci).pluck(:other_directives_regulations).first || "N/A" %>
                                </br>
                            </div>
                        <% end %>
                        </p>
                        <p>
                            <% if Comedogeniclist.where(ingredient: inci).exists? %>
                            <div class="toggle_comedogenic">>>> Comedogenic Cosmetic List <<<</br>
                                <div class="title">Rating:</div> <%= Comedogeniclist.where(ingredient: inci).pluck(:rating).first || "N/A" %>
                                </br>
                                <div class="title">Research Evidence: </div>
                                <%= "Fulton (1989)" if Comedogeniclist.where(ingredient: inci).pluck(:fulton_1989).first == "TRUE" %>
                                <%= "Morris Kwan (1983)" if Comedogeniclist.where(ingredient: inci).pluck(:morris_kwan_1983).first == "TRUE" %>
                                <%= "N/A" if Comedogeniclist.where(ingredient: inci).pluck(:morris_kwan_1983).first == "FALSE" and Comedogeniclist.where(ingredient: inci).pluck(:morris_kwan_1983).first == "FALSE" %>
                                </br>
                            </div>
                            <% end %>
                        </p>


                      </div>
                    </div>
                    <% end %>
                <!-- count no of ingredients flagged RED in product/category/brand selected -->
                    <% @count_hash = Hash.new(0) %>
                    <% if @potential_product.nil? %>
                        <% @total << ["no breakout ingredient found!"] %>
                    <% elsif @potential_product.include?(inci) %>
                        <% @total << inci %> 
                    <% elsif @potential_product.exclude?(inci) %>
                        <% @total << "safe ingredients" %>
                    <% end %>
                    <% @total.each do |v| %>
                        <% @count_hash[v] += 1 %>
                    <% end %>
                    <% i+=1 %>
                <% end %>
            </div>
        <% result_list_counter+=1 %>
        
        </p>
        </div>
        <% end %>
    <!-- testing purposes -->   
    <%#= @potential_product %>
    <%#= @potential_product.count %>
    <% elsif @ingredient_hash_manual.present? %>
        <% @ingredient_hash_manual.each do |key, value| %>
        <div class="result_list">
       <!-- p for each product -->
       <p>
            <div class="product"><%= params[:manual_product] %></div></br>
            <div class="product_img_manual">no image:manually entered product</div></br>
           <!--  <div class="amazon_buy">Buy Now</div> -->
            <!--
            <%# unless current_user.favorites.exists?(key) %>
                <%#= link_to favorite_product_path(key), method: :put, remote: true do %><div class="add_faves" id="add_faves_<%#= result_list_counter %>">&star;</div><%# end %>
                <%#= link_to favorite_product_path(key), method: :delete, remote: true do %><div class="remove_faves" id="remove_faves_<%= result_list_counter %>" style="display: none;">&starf;</div><%# end %>
            <%# else %>
                <%#= link_to favorite_product_path(key), method: :put, remote: true do %><div class="add_faves" id="add_faves_<%#= result_list_counter %>" style="display: none;">&star;</div><%# end %>
                <%#= link_to favorite_product_path(key), method: :delete, remote: true do %><div class="remove_faves" id="remove_faves_<%= result_list_counter %>">&starf;</div><%# end %>
            <%# end %>
                -->
            <%= link_to new_suggest_path do %><div class="report_error">Error?</div><% end %>
            <br style="clear:left;"/><br />
                <!-- javascript added here to loop through result_list_counter for product-favorite matching -->
                <script>
                $(document).ready(function(){
                    $('#add_faves_<%= result_list_counter %>').on('click', function(){
                        document.getElementById('remove_faves_<%= result_list_counter %>').style.display = 'block';
                        document.getElementById('add_faves_<%= result_list_counter %>').style.display = 'none';
                    });
                    $('#remove_faves_<%= result_list_counter %>').on('click', function(){
                        document.getElementById('add_faves_<%= result_list_counter %>').style.display = 'block';
                        document.getElementById('remove_faves_<%= result_list_counter %>').style.display = 'none';
                    });
                });
                </script>
            <div class="ingredient_count"><span style="color:rgba(255,0,0,1); font-size: 15px;"><%= value.count %></span> ingredient(s) found:
            </div>
            <div class="legend">
                <span style="background: rgba(255,255,0,1);">&nbsp;&nbsp;&nbsp;</span>:Breakout-causing List | <%= image_tag("canada_flag.png", alt: " [Health Canada] ", size: "19") %>:HC Hotlist | <%= image_tag("eu_flag.png", alt: " [EU] ", size: "19") %>:EU Prohibited List | <%= image_tag("comedogenic_icon.png", alt: " [Comedogenic List] ", size: "19") %>:Comedogenic List | <%= link_to how_it_works_path do %>How It Works&quest;<% end %>
            </div> 
            <!-- use i as a counter for data-target & collapse id matching -->
            <% i=0 %>
            <div class="ingredients_list">
                <!-- downcase and strip b/c @potential_product is already downcased and stripped -->
                <% value.compact.map(&:downcase).map(&:strip).each do |inci| %>
                    <% unless inci.nil? %>
                    <div class="collapse_view" data-toggle="collapse" data-target="#<%= i %>" aria-expanded="false" aria-controls="collapseExample">
                        <!-- css .highlight if potential ingredient -->
                        <% if @potential_product.nil? %>
                        <%= inci %>
                        <% elsif @potential_product.include?(inci) %>
                            <span style="background: rgba(255,255,0,1);"><%= inci %></span>
                        <% else %>
                        <%= inci %>
                        <% end %>

                    <%= image_tag("canada_flag.png", alt: " [Health Canada] ", size: "19") if Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).exists? %>
                    <%= image_tag("eu_flag.png", alt: " [EU] ", size: "19") if CosingAnnexIi.where(chemical_name_inn: inci).exists? %>
                    <%= image_tag("comedogenic_icon.png", alt: " [Comedogenic List] ", size: "19") if Comedogeniclist.where(ingredient: inci).exists? %>
                    </div>
                  
                    <div class="collapse" id="<%= i %>">
                      <div class="well">
                        <p>
                        <div class="title">Function:</div>
                        <% if Cosing.where(INCI_name: inci).pluck(:Function).nil? or Cosing.where(INCI_name: inci).pluck(:Function).empty? %>
                            Unknown
                        <% else %>
                            <%= Cosing.where(INCI_name: inci).pluck(:Function).first %>
                        <% end %>
                        </p>
                        <p>
                            <% if Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).exists? %>
                            <div class="toggle_HC">>>> Health Canada's Hotlists <<<</br>
                                <div class="title">Status (restricted/prohibited):</div> <%= Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).pluck(:status).first || "N/A" %>
                                </br>
                                <div class="title">Conditions of Use:</div> <%= Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).pluck(:conditions_of_use).first || "N/A" %>
                                </br>
                                <div class="title">Maximum concentration permitted:</div> <%= Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).pluck(:maximum_concentration_permitted).first || "N/A" %>
                                </br>
                                <div class="title">Warnings & Cautions:</div> <%= Healthcanadahotlist.where('ingredient = ? OR ingredient_original = ?', inci, inci).pluck(:warnings_and_cautions).first || "N/A" %>
                                </br>
                            </div>
                        <% end %>
                        </p>
                        <p>
                            <% if CosingAnnexIi.where(chemical_name_inn: inci).exists? %>
                            <div class="toggle_EU">>>> European Union's Prohibited List <<<</br>
                                <div class="title">Opinions:</div> <%= CosingAnnexIi.where(chemical_name_inn: inci).pluck(:sccs_opinions).first || "N/A"%>
                                </br>
                                <div class="title">Other directives/regulations:</div> <%= CosingAnnexIi.where(chemical_name_inn: inci).pluck(:other_directives_regulations).first || "N/A" %>
                                </br>
                            </div>
                        <% end %>
                        </p>
                        <p>
                            <% if Comedogeniclist.where(ingredient: inci).exists? %>
                            <div class="toggle_comedogenic">>>> Comedogenic Cosmetic List <<<</br>
                                <div class="title">Rating:</div> <%= Comedogeniclist.where(ingredient: inci).pluck(:rating).first || "N/A" %>
                                </br>
                                <div class="title">Research Evidence: </div>
                                <%= "Fulton (1989)" if Comedogeniclist.where(ingredient: inci).pluck(:fulton_1989).first == "TRUE" %>
                                <%= "Morris Kwan (1983)" if Comedogeniclist.where(ingredient: inci).pluck(:morris_kwan_1983).first == "TRUE" %>
                                <%= "N/A" if Comedogeniclist.where(ingredient: inci).pluck(:morris_kwan_1983).first == "FALSE" and Comedogeniclist.where(ingredient: inci).pluck(:morris_kwan_1983).first == "FALSE" %>
                                </br>
                            </div>
                            <% end %>
                        </p>


                      </div>
                    </div>
                    <% end %>
                <!-- count no of ingredients flagged RED in product/category/brand selected -->
                    <% @count_hash = Hash.new(0) %>
                    <% if @potential_product.nil? %>
                        <% @total << ["no breakout ingredient found!"] %>
                    <% elsif @potential_product.include?(inci) %>
                        <% @total << inci %> 
                    <% elsif @potential_product.exclude?(inci) %>
                        <% @total << "safe ingredients" %>
                    <% end %>
                    <% @total.each do |v| %>
                        <% @count_hash[v] += 1 %>
                    <% end %>
                    <% i+=1 %>
                <% end %>
            </div>
        </p>
        </div>
        <% end %>
    <% else %>
    
    <% end %>

        <%#= link_to 'Back', analyze_path %>

        <!-- testing purposes -->
        <%# if @count_hash.present? %>
        <%# @count_hash.each do |k, v| %>
        <%#= v %>
        <%# end %>
        <%# end %>
    
        <%# @total.each do |t| %>
        <%#= t %>
        <%# end %>
    </div>
</div>

<script>
<% if @count_hash.present? %>
    var bar_data = {
        labels: [<% @count_hash.each_key do |key| %>
            "<%= key %>",
            <% end %>],
        datasets: [
            {      
                barThickness: "1px",
                backgroundColor: "rgba(255,99,132,0.2)",
                borderColor: "rgba(255,99,132,1)",
                borderWidth: 1,
                hoverBackgroundColor: "rgba(255,99,132,0.4)",
                hoverBorderColor: "rgba(255,99,132,1)",
                data: [<% @count_hash.each_value do |value| %>
            <%= value %>,
            <% end %>],
            }
        ]
    };
    var overall_hazard_polarArea_data = {
       labels: [
            <% @count_hash.each_key do |key| %>
            "<%= key %>",
            <% end %>
           ],
        datasets: [
            {
                data: [
            <% @count_hash.each_value do |value| %>
            <%= value %>,
            <% end %>
                    ]
            }]
    };
<% end %>
    // always show tooltip
    Chart.pluginService.register({
            beforeRender: function (chart) {
                if (chart.config.options.showAllTooltips) {
                    // create an array of tooltips
                    // we can't use the chart tooltip because there is only one tooltip per chart
                    chart.pluginTooltips = [];
                    chart.config.data.datasets.forEach(function (dataset, i) {
                        chart.getDatasetMeta(i).data.forEach(function (sector, j) {
                            chart.pluginTooltips.push(new Chart.Tooltip({
                                _chart: chart.chart,
                                _chartInstance: chart,
                                _data: chart.data,
                                _options: chart.options.tooltips,
                                _active: [sector]
                            }, chart));
                        });
                    });

                    // turn off normal tooltips
                    chart.options.tooltips.enabled = false;
                }
            },
            afterDraw: function (chart, easing) {
                if (chart.config.options.showAllTooltips) {
                    // we don't want the permanent tooltips to animate, so don't do anything till the animation runs atleast once
                    if (!chart.allTooltipsOnce) {
                        if (easing !== 1)
                            return;
                        chart.allTooltipsOnce = true;
                    }

                    // turn on tooltips
                    chart.options.tooltips.enabled = true;
                    Chart.helpers.each(chart.pluginTooltips, function (tooltip) {
                        tooltip.initialize();
                        tooltip.update();
                        // we don't actually need this since we are not animating tooltips
                        tooltip.pivot();
                        tooltip.transition(easing).draw();
                    });
                    chart.options.tooltips.enabled = false;
                }
            }
        })

    // Global Configuration

    // Get the context of the canvas element we want to select
    var ctx = document.getElementById("barChart").getContext("2d");
    var myBarChart = new Chart(ctx, {
        type: 'horizontalBar', 
        data: bar_data,
        options: {
            scales: {
                xAxes: [{
                    stacked: true,
                    ticks: {
                                 beginAtZero: true,
                                 userCallback: function(label, index, labels) {
                                     // when the floored value is the same as the value we have a whole number
                                     if (Math.floor(label) === label) {
                                         return label;
                                     }
                                 },
                             }
                }],
                yAxes: [{
                    categorySpacing: 0,
                    barPercentage: 0.5,
                    categoryPercentage: 0.5
                }]
            },
            legend: {
                display: false
            },
           showAllTooltips: true,
           tooltips: {
              custom: function(tooltip) {
                if (!tooltip) return;
                // disable displaying the color box;
                tooltip.displayColors = false;
              },
              callbacks: {
                // use label callback to return the desired label
                label: function(tooltipItem, data) {
                  return tooltipItem.xLabel;
                },
                // remove title
                title: function(tooltipItem, data) {
                  return;
                }
              }
            }
        }
    });

    var ctx = document.getElementById("overall_hazard").getContext("2d");
    var myPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: overall_hazard_polarArea_data
    });

    var ctx = document.getElementById("cancer").getContext("2d");
    var myPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: cancer_pie_data
    });

    var ctx = document.getElementById("developmental").getContext("2d");
    var myPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: developmental_pie_data
    });
    var ctx = document.getElementById("allergies").getContext("2d");
    var myPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: allergies_pie_data
    });
    var ctx = document.getElementById("restrictions").getContext("2d");
    var myPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: restrictions_pie_data
    });
</script>
